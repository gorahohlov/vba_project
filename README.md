# Немного о проекте.
---

Я написал несколько пользовательских функций и несколько процедур для решения часто встречающихся задач в процессе таможенной аналитики и подготовки (набивки) таможенной декларации.

В сущности проект состоит из трех модyлей:

- `personal.bas`; здесь находятся процедуры;

- `my_funcs.bas`; здесь находятся пользовательские функции. Их пришлось выделить в отдельный модуль, чтобы было возможно вызывать эти пользовательские функции на рабочем листе без ссылки на файл и модуль содержащих их код, т.е. также как встроенные функции рабочего листа. Для этого пришлось зарегистировать файл `my_funcs.xlam` как надстройку Excel. Об этом напишу позже.

- `UserForm1.frm` - файл скриптов для обработки событий пользовательской формы, а также связанный с ним файл `UserForm1.frx` (бинарный файл визуального вида пользвательской формы); Эти файлы находятся в блоках кода связанных с пользовательской формой в файле (рабочей книге) `PERSONAL.XLSB`;
---

Итак, модуль кода файла `PERSONAL.XLSB` - содержит следующие пользовательские процедуры: 

- `highlight_codes_39`
    для определения и подсветки кодов ТНВЭД из массива кодов по которым требуется "набивать" отдельный товар (ПП № 39);

- `highlight_codes_342`
    для определения кодов, по которым начисляется таможенный сбор на всю ДТ в размере 30000_₽;

- `highlight_cells`
    эта процедура делает и то и другое вместе.

- функция `IsInArray`
    вспомогательная для трех вышеуказанных процедур;

- `cells_numbering`
    предназначена для "затейливой" нумерации строк (без учета скрытых строк, нумерация не с единицы ...)

- `partial_match`
    процедура, которая предназначена для подтягивания данных по ключевому полю (например, артикулу) из таблицы содержащейся на другом листе или в другой книге. 
Связанные с этой процедурой блоки кода: `Declarations` - объявление глобальных, на уровне модуля, переменных  для того чтобы передать параметры связанным с формой процедурам обработки событий и обратное в процедуру `partial_match`; вспомогательная процедура `paint_cells` предназначенная для форматирования ячеек по результатам поиска.

    процедура `partial_match` используется для поиска по частичному совпадению ключевого_слова; для передачи в процедуру различных параметров используется пользовательская форма. Файлы связанные с пользовательской формой размещены также в файле `PERSONAL.XLSB` (макет и скрипты обработки событий формы - в блоке кода связанном с Пользовательской формой); их не нужно переносить в другой файл, иначе нарушатся зависимости. Процедура (`partial_match`) использует пользовательскую функцию `vlookup4` (модифицировнную функцию `ВПР`), которая хранится в модуле файла `my_funcs.xlam`;

### Ключевые моменты с PERSONAL.XSLB:
---

Можно порекомендовать хранить перечисленные выше процедуры в личной книге макросов (она же `PERSONAL.XLSB`) по стандартному адресу: `C:\Users\User\AppData\Roaming\Microsoft\Excel\XLSTART` под таким же именем. Эта книга будет автоматически загужаться при каждом запуске приложения Excel, она будет скрыта - т.е. не будет мозолить глаза, но при этом процедуры из модуля в этой книге (файла) будут всегда доступны. 

**ВАЖНО!** процедура `partial_match` использует фукнцию `vlookup4` (`ВПР4`) и эта функция  должна находиться в области видимости процедуры `partial_match`. Как это сделать пойдет речь позже, когда буду говорить про файл `my_funcs.xlam`.

### Файл my_funcs.xlam:
---

Это файл надстроек Excel. В нем содержатся пользовательские функции, область видимости которых все приложение (все запущенные в сеансе рабочие книги). Это функция `custom_toll` (`ТАМ_СТОИМ`) и модифицированные функции ВПР (`VLookUp2` (`ВПР2`), `VLookUp3` (`ВПР3`), `VLookUp4` (`ВПР4`)).

Удобно поместить эти пользовательские функции в отдельных файл и зарегистрировать его в качестве надстройки (с расширением `xlam`) для того чтобы можно было вводить пользовательские функции объявленные в нем) в формулах рабочего листа без ссылок на файл (рабочую книгу) их содержащую; б) без необходимости открывать рабочую книгу с пользовательскими функциями, чтобы добавить их в область видимости активной книги; в) иметь возможность запускать макросы (процедуры), которые ссылаются на пользовательские функции без открытия файлов с пользовательскими функциями.

Для простого использования пользовательских функций в формулах рабочего листа или в процедурах (макросах) без указания ссылки на файл рабочей книги, без окрытия файла рабочей книги, содержащей такие пользовательские функции, нужно сделать одно из двух:

- Установить ссылку на рабочую книгу. Это можно сделать с помощью меню VBE (Visual Basic Editor - переход по Alt-F11) `Tools -> References` (Сервис -> Ссылки). По умолчанию VBA проекты имеют однаковые названия `VBAProject` (так же они перечислены в окне `Tools/References`). Чтобы не запутаться можно рекомендовать переименовать прокет в окне Project редактора Visual Basic Editor (VBE) - пункт контекстного меню Properties.

- Создать надстройку. При создании надстройки на основе рабочей книги, в которой представлены функции, можно не задавать ссылку на файл, если одна из функций используется в формуле. Для этого необходимо файл Excel с макросами сохранить как `.xlam` (предпочтительно, но не обязательно в папку `C:\Users\User\AppData\Roaming\Microsoft\AddIns`); Далее перейти в меню File -> Excel_Options -> Add-ins (Файл -> Параметры -> Надстройки). В диалоговом окне Параметры Excel (Excel Options) в списке Управление (Manage) нужно выбрать пункт Надстройки Excel (ExcelAdd-Ins) и щелкнуть на кнопке Перейти (Go). После завершения установки надстройка появится в следующем запуске Excel.